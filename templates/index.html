<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Sensei: AI Enabled Sales Training</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico"> 
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Sales Sensei: AI Enabled Sales Training</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('signup') }}">Signup</a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="header">
        <img src="{{ url_for('static', filename='apple_ninja.png') }}" alt="Apple Ninja">
    </div>

    <div id="prompt-container" class="mt-4">
        <div id="prompts"></div>
    </div>

<div class="container chat-container">
    <div id="chat-container" class="card mt-4">
        <div class="card-body">
            <div class="form-group">
                <h5>Enter Objection:</h5>
                <textarea id="objection-input" class="form-control" placeholder="Enter a sales objection"></textarea>
            </div>
            <div class="form-group">
                <h5>Enter Your Suggested Way of Dealing with It (Optional):</h5>
                <textarea id="response-input" class="form-control" placeholder="How would you address this objection?"></textarea>
            </div>
            <div class="text-center">
                <button id="chat-submit" class="btn btn-primary">Get Advice</button>
            </div>

            <div id="chat-output" class="mt-4"></div>

            <div id="loading-bar" class="progress d-none">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
            </div>

            <div class="rate-response mt-4">
                <div class="form-group">
                    <input type="number" id="rating-input" class="form-control" placeholder="How helpful was the advice you received (1 is unhelpful, 5 is very helpful)">
                </div>
                <div class="text-center">
                    <button id="rate-submit" class="btn btn-secondary">Rate Response</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.getElementById("rate-submit").addEventListener("click", async () => {
        const ratingInput = document.getElementById("rating-input");
        const chatOutput = document.getElementById("chat-output");
        const rating = ratingInput.value;

        if (rating && rating >= 1 && rating <= 5) {
            const ratingResponse = await sendRating(rating);

            const ratingResponseElement = document.createElement("p");
            ratingResponseElement.textContent = "Thank you for your rating, we use this to improve your experience!";
            chatOutput.appendChild(ratingResponseElement);

            document.getElementById("objection-input").value = "";
            document.getElementById("response-input").value = "";
            ratingInput.value = "";
        } else {
            alert("How helpful was the advice you received (1 is unhelpful, 5 is very helpful)");
        }

        document.querySelector('.rate-response').style.display = 'none';
        while (chatOutput.firstChild) {
            chatOutput.removeChild(chatOutput.firstChild);
        }
    });
</script>

<script>
    async function sendRating(rating) {
        const ratingResponse = await fetch('/rate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rating: rating, interaction_id: interactionId })
        });

        return await ratingResponse.json();
    }
</script>

<script>
    const examplePrompts = [
        "Your competitor is cheaper",
        "This looks too complicated for my team to learn",
        "Weâ€™re using this budget elsewhere",
        "This is too expensive"
    ];

    function displayExamplePrompts() {
        const container = document.getElementById("prompts");
        examplePrompts.forEach(prompt => {
            const div = document.createElement("div");
            div.classList.add("prompt");
            div.textContent = prompt;
            div.onclick = () => {
                document.getElementById("objection-input").value = prompt;
            };
            container.appendChild(div);
        });
    }

    displayExamplePrompts();
</script>

<script>
    document.getElementById("chat-submit").addEventListener("click", async () => {
        const objectionInput = document.getElementById("objection-input");
        const responseInput = document.getElementById("response-input");
        const objection = objectionInput.value;
        const response = responseInput.value;
        if (objection && (objection.length > 0 || response.length > 0)) {
            const chatOutput = document.getElementById("chat-output");

            const objectionElement = document.createElement("p");
            objectionElement.innerHTML = "<strong>Objection:</strong> " + objection;
            const responseElement = document.createElement("p");
            responseElement.innerHTML = "<strong>Your response:</strong> " + response;

            chatOutput.appendChild(objectionElement);
            chatOutput.appendChild(responseElement);

            const loadingBar = document.getElementById("loading-bar");
            loadingBar.classList.remove("d-none");

            const serverResponse = await sendChatMessage(objection, response);

            loadingBar.classList.add("d-none");

            let feedbackContent = "<strong>Sales Sensei says:</strong> ";
            let paragraphs = serverResponse.split('\n');
            for (let i = 0; i < paragraphs.length; i++) {
                let feedbackElement = document.createElement("p");
                feedbackElement.innerHTML = (i === 0 ? feedbackContent : "") + paragraphs[i];
                chatOutput.appendChild(feedbackElement);
            }

            objectionInput.value = "";
            responseInput.value = "";
        } else if (response.length > 0) {
            alert('Please enter an objection before providing a response');
        }
        document.querySelector('.rate-response').style.display = 'block';
    });
</script>

<script>
    let interactionId = null;

    async function sendChatMessage(objection, response) {
        const serverResponse = await fetch('/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_objection: objection, user_response: response })
        });

        const data = await serverResponse.json();
        interactionId = data.interaction_id;
        return data.response_text;
    }
</script>

<script>
    window.addEventListener('pageshow', function (event) {
        if (event.persisted) {
            window.location.reload();
        }
    });
</script>
</body>
</html>